<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Search - FragmentEngine</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            min-height: 100vh;
            color: #e7e9ea;
        }
        .app { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #16181c;
            border-right: 1px solid #2f3336;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo .material-icons { color: #1d9bf0; }

        /* Search */
        .search-box {
            background: #1d1f23;
            border: 1px solid #2f3336;
            border-radius: 0.5rem;
            padding: 0.625rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e7e9ea;
            font-size: 0.875rem;
            outline: none;
        }
        .search-box input::placeholder { color: #71767b; }
        .search-box .material-icons { color: #71767b; font-size: 1.25rem; }

        /* Filters */
        .filter-section { margin-bottom: 1rem; }
        .filter-label {
            font-size: 0.65rem;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.375rem;
        }
        .filter-select {
            width: 100%;
            background: #1d1f23;
            border: 1px solid #2f3336;
            border-radius: 0.375rem;
            padding: 0.5rem 0.625rem;
            color: #e7e9ea;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: #1d9bf0; }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 1rem;
        }
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(29,155,240,0.15);
            color: #1d9bf0;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
        }
        .filter-tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            display: flex;
        }
        .filter-tag .material-icons { font-size: 0.875rem; }

        .clear-btn {
            background: none;
            border: 1px solid #2f3336;
            color: #71767b;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.375rem 0.625rem;
            border-radius: 0.375rem;
            width: 100%;
            transition: all 0.2s;
        }
        .clear-btn:hover { border-color: #1d9bf0; color: #1d9bf0; }

        /* Nav links */
        .nav-section { margin-top: auto; padding-top: 1rem; border-top: 1px solid #2f3336; }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            color: #71767b;
            text-decoration: none;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.15s;
        }
        .nav-link:hover { background: #1d1f23; color: #e7e9ea; }
        .nav-link .material-icons { font-size: 1.1rem; }

        /* Main content */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 1.25rem 2rem;
        }

        /* Results header */
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #2f3336;
        }
        .results-count {
            font-size: 0.875rem;
            color: #71767b;
        }
        .results-count strong { color: #e7e9ea; }
        .sort-select {
            background: #1d1f23;
            border: 1px solid #2f3336;
            border-radius: 0.375rem;
            padding: 0.375rem 0.625rem;
            color: #e7e9ea;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Results list */
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .result-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .result-card:hover { border-color: #1d9bf0; }
        .result-card.expanded { border-color: #1d9bf0; background: #1d1f23; }

        .result-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .result-icon {
            width: 32px;
            height: 32px;
            border-radius: 0.375rem;
            background: rgba(0,186,124,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .result-icon .material-icons { color: #00ba7c; font-size: 1rem; }

        .result-info { flex: 1; min-width: 0; }
        .result-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        .result-url {
            font-size: 0.7rem;
            color: #00ba7c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.375rem;
        }
        .result-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }
        .result-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.65rem;
            cursor: pointer;
        }
        .result-tag.platform { background: rgba(29,155,240,0.15); color: #1d9bf0; }
        .result-tag.readability { background: #2f3336; color: #e7e9ea; }
        .result-tag.readability.easy { background: rgba(0,186,124,0.15); color: #00ba7c; }
        .result-tag.readability.moderate { background: rgba(247,183,51,0.15); color: #f7b733; }
        .result-tag.readability.hard { background: rgba(249,24,128,0.15); color: #f91880; }

        .result-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            flex-shrink: 0;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #2f3336;
            border: none;
            color: #e7e9ea;
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
        }
        .action-btn:hover { background: #3f4346; }
        .action-btn .material-icons { font-size: 0.875rem; }

        .result-preview {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #2f3336;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #a0a0a0;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #71767b;
        }
        .loading .material-icons {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #71767b;
        }
        .empty-state .material-icons {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #2f3336;
        }
        .page-btn {
            background: #1d1f23;
            border: 1px solid #2f3336;
            color: #e7e9ea;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .page-btn:hover { border-color: #1d9bf0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { color: #71767b; font-size: 0.75rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const TYPESENSE_BASE = '/typesense';
        const TYPESENSE_KEY = 'your-secure-api-key-here';

        async function tsSearch(collection, params) {
            const query = new URLSearchParams(params).toString();
            const res = await fetch(`${TYPESENSE_BASE}/collections/${encodeURIComponent(collection)}/documents/search?${query}`, {
                method: 'GET',
                headers: { 'X-TYPESENSE-API-KEY': TYPESENSE_KEY }
            });
            if (!res.ok) throw new Error(`Typesense error: ${res.status}`);
            return res.json();
        }

        async function tsFacets(collection, facetBy, filterBy = '', maxFacets = 100) {
            const params = {
                q: '*',
                query_by: 'title',
                facet_by: facetBy,
                max_facet_values: maxFacets,
                per_page: 0
            };
            if (filterBy) params.filter_by = filterBy;
            return tsSearch(collection, params);
        }

        function App() {
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchInput, setSearchInput] = useState('');
            const [platformFilter, setPlatformFilter] = useState('');
            const [topicFilter, setTopicFilter] = useState('');
            const [contentSort, setContentSort] = useState('readability-hard');

            const [platforms, setPlatforms] = useState([]);
            const [topics, setTopics] = useState([]);
            const [content, setContent] = useState([]);
            const [expandedId, setExpandedId] = useState(null);

            const [page, setPage] = useState(1);
            const perPage = 25;

            // Read URL params
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const searchParam = params.get('search');
                const platformParam = params.get('platform');
                const topicParam = params.get('topic');
                if (searchParam) {
                    setSearchQuery(searchParam);
                    setSearchInput(searchParam);
                }
                if (platformParam) setPlatformFilter(platformParam);
                if (topicParam) setTopicFilter(topicParam);
            }, []);

            // Update URL when filters change
            useEffect(() => {
                const params = new URLSearchParams();
                if (searchQuery) params.set('search', searchQuery);
                if (platformFilter) params.set('platform', platformFilter);
                if (topicFilter) params.set('topic', topicFilter);
                const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }, [searchQuery, platformFilter, topicFilter]);

            // Load data
            useEffect(() => {
                loadData();
            }, [searchQuery, platformFilter, topicFilter, contentSort]);

            async function loadData() {
                setLoading(true);
                setPage(1);
                try {
                    // Load platforms from content_pages
                    const platformData = await tsFacets('content_pages', 'host', '', 50);
                    const platformFacets = platformData.facet_counts?.find(f => f.field_name === 'host')?.counts || [];
                    setPlatforms(platformFacets.map(p => ({ value: p.value, count: p.count })));

                    // Load topics from content_pages
                    const topicData = await tsFacets('content_pages', 'life_events', '', 100);
                    const topicFacets = topicData.facet_counts?.find(f => f.field_name === 'life_events')?.counts || [];
                    setTopics(topicFacets.map(t => ({ value: t.value, count: t.count })));

                    // Load fragments
                    const contentParams = {
                        q: searchQuery || '*',
                        query_by: 'title,content_text',
                        include_fields: 'id,url,title,content_text,reading_level',
                        per_page: 250
                    };

                    if (contentSort === 'readability-hard') {
                        contentParams.sort_by = 'reading_level:desc';
                    } else if (contentSort === 'readability-easy') {
                        contentParams.sort_by = 'reading_level:asc';
                    }

                    const contentData = await tsSearch('content_fragments', contentParams);

                    // Map and filter client-side
                    let contentList = (contentData.hits || []).map(hit => ({
                        id: hit.document.id,
                        title: hit.document.title || 'Untitled',
                        content_text: hit.document.content_text || '',
                        reading_level: hit.document.reading_level || 8,
                        url: hit.document.url,
                        host: extractHost(hit.document.url)
                    }));

                    // Apply platform filter client-side
                    if (platformFilter) {
                        contentList = contentList.filter(item =>
                            item.url && item.url.includes(platformFilter)
                        );
                    }

                    // Apply topic filter - get pages with topic, then filter fragments
                    if (topicFilter) {
                        const topicPages = await tsSearch('content_pages', {
                            q: '*',
                            query_by: 'title',
                            filter_by: `life_events:=${topicFilter}`,
                            include_fields: 'url',
                            per_page: 250
                        });
                        // Get URL paths (without query params) for matching
                        const pageUrlPaths = (topicPages.hits || []).map(h => getUrlPath(h.document.url));

                        contentList = contentList.filter(item => {
                            const itemPath = getUrlPath(item.url || '');
                            return pageUrlPaths.some(pagePath =>
                                itemPath === pagePath ||
                                itemPath.startsWith(pagePath) ||
                                pagePath.startsWith(itemPath)
                            );
                        });
                    }

                    setContent(contentList);

                } catch (err) {
                    console.error('Error loading data:', err);
                }
                setLoading(false);
            }

            function extractHost(url) {
                try { return new URL(url).hostname; } catch { return ''; }
            }

            function getUrlPath(url) {
                try {
                    const u = new URL(url);
                    return u.origin + u.pathname;
                } catch {
                    return url.split('?')[0].split('#')[0];
                }
            }

            function getReadabilityClass(level) {
                if (level <= 8) return 'easy';
                if (level <= 10) return 'moderate';
                return 'hard';
            }

            function getReadabilityLabel(level) {
                return `Grade ${level}`;
            }

            function handleSearch(e) {
                e.preventDefault();
                setSearchQuery(searchInput);
            }

            function clearFilters() {
                setSearchQuery('');
                setSearchInput('');
                setPlatformFilter('');
                setTopicFilter('');
            }

            // Sort content
            const sortedContent = useMemo(() => {
                let sorted = [...content];
                if (contentSort === 'title') {
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                }
                return sorted;
            }, [content, contentSort]);

            // Paginate
            const totalPages = Math.ceil(sortedContent.length / perPage);
            const paginatedContent = sortedContent.slice((page - 1) * perPage, page * perPage);

            const hasFilters = searchQuery || platformFilter || topicFilter;

            return (
                <div className="app">
                    <aside className="sidebar">
                        <div className="logo">
                            <span className="material-icons">search</span>
                            Content Search
                        </div>

                        <form onSubmit={handleSearch}>
                            <div className="search-box">
                                <span className="material-icons">search</span>
                                <input
                                    type="text"
                                    placeholder="Search content..."
                                    value={searchInput}
                                    onChange={e => setSearchInput(e.target.value)}
                                />
                            </div>
                        </form>

                        {hasFilters && (
                            <div className="active-filters">
                                {searchQuery && (
                                    <span className="filter-tag">
                                        "{searchQuery}"
                                        <button onClick={() => { setSearchQuery(''); setSearchInput(''); }}>
                                            <span className="material-icons">close</span>
                                        </button>
                                    </span>
                                )}
                                {platformFilter && (
                                    <span className="filter-tag">
                                        {platformFilter}
                                        <button onClick={() => setPlatformFilter('')}>
                                            <span className="material-icons">close</span>
                                        </button>
                                    </span>
                                )}
                                {topicFilter && (
                                    <span className="filter-tag">
                                        {topicFilter}
                                        <button onClick={() => setTopicFilter('')}>
                                            <span className="material-icons">close</span>
                                        </button>
                                    </span>
                                )}
                            </div>
                        )}

                        <div className="filter-section">
                            <div className="filter-label">Platform</div>
                            <select
                                className="filter-select"
                                value={platformFilter}
                                onChange={e => setPlatformFilter(e.target.value)}
                            >
                                <option value="">All platforms</option>
                                {platforms.map(p => (
                                    <option key={p.value} value={p.value}>
                                        {p.value} ({p.count})
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-section">
                            <div className="filter-label">Topic / Life Event</div>
                            <select
                                className="filter-select"
                                value={topicFilter}
                                onChange={e => setTopicFilter(e.target.value)}
                            >
                                <option value="">All topics</option>
                                {topics.map(t => (
                                    <option key={t.value} value={t.value}>
                                        {t.value} ({t.count})
                                    </option>
                                ))}
                            </select>
                        </div>

                        {hasFilters && (
                            <button className="clear-btn" onClick={clearFilters}>
                                Clear all filters
                            </button>
                        )}

                        <nav className="nav-section">
                            <a href="index.html" className="nav-link">
                                <span className="material-icons">home</span>
                                Home
                            </a>
                            <a href="dashboard-portfolio.html" className="nav-link">
                                <span className="material-icons">dashboard</span>
                                Portfolio Dashboard
                            </a>
                            <a href="aeo-analysis.html" className="nav-link">
                                <span className="material-icons">psychology</span>
                                AEO Analysis
                            </a>
                        </nav>
                    </aside>

                    <main className="main">
                        {loading ? (
                            <div className="loading">
                                <span className="material-icons">sync</span>
                                Loading content...
                            </div>
                        ) : (
                            <>
                                <div className="results-header">
                                    <div className="results-count">
                                        <strong>{sortedContent.length}</strong> results
                                        {hasFilters && ' matching filters'}
                                    </div>
                                    <select
                                        className="sort-select"
                                        value={contentSort}
                                        onChange={e => setContentSort(e.target.value)}
                                    >
                                        <option value="readability-hard">Hardest to read</option>
                                        <option value="readability-easy">Easiest to read</option>
                                        <option value="title">Alphabetical</option>
                                        <option value="relevance">Relevance</option>
                                    </select>
                                </div>

                                {sortedContent.length === 0 ? (
                                    <div className="empty-state">
                                        <span className="material-icons">search_off</span>
                                        <div>No content found</div>
                                        <div style={{fontSize: '0.8rem', marginTop: '0.5rem'}}>
                                            Try adjusting your search or filters
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="results-list">
                                            {paginatedContent.map(item => (
                                                <div
                                                    key={item.id}
                                                    className={`result-card ${expandedId === item.id ? 'expanded' : ''}`}
                                                    onClick={() => setExpandedId(expandedId === item.id ? null : item.id)}
                                                >
                                                    <div className="result-header">
                                                        <div className="result-icon">
                                                            <span className="material-icons">article</span>
                                                        </div>
                                                        <div className="result-info">
                                                            <div className="result-title">{item.title}</div>
                                                            <div className="result-url">{item.url}</div>
                                                            <div className="result-meta">
                                                                <span
                                                                    className="result-tag platform"
                                                                    onClick={e => { e.stopPropagation(); setPlatformFilter(item.host); }}
                                                                >
                                                                    {item.host}
                                                                </span>
                                                                <span className={`result-tag readability ${getReadabilityClass(item.reading_level)}`}>
                                                                    {getReadabilityLabel(item.reading_level)}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div className="result-actions">
                                                            <a
                                                                className="action-btn"
                                                                href={`dashboard-content.html?page_url=${encodeURIComponent((item.url || '').split('#')[0])}`}
                                                                onClick={e => e.stopPropagation()}
                                                            >
                                                                <span className="material-icons">dashboard</span>
                                                                Page
                                                            </a>
                                                            <a
                                                                className="action-btn"
                                                                href={`aeo-analysis.html?fragment=${encodeURIComponent(item.id)}`}
                                                                onClick={e => e.stopPropagation()}
                                                            >
                                                                <span className="material-icons">psychology</span>
                                                                AEO
                                                            </a>
                                                            <a
                                                                className="action-btn"
                                                                href={item.url}
                                                                target="_blank"
                                                                onClick={e => e.stopPropagation()}
                                                            >
                                                                <span className="material-icons">open_in_new</span>
                                                                Source
                                                            </a>
                                                        </div>
                                                    </div>
                                                    {expandedId === item.id && item.content_text && (
                                                        <div className="result-preview">
                                                            {item.content_text}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        {totalPages > 1 && (
                                            <div className="pagination">
                                                <button
                                                    className="page-btn"
                                                    onClick={() => setPage(p => Math.max(1, p - 1))}
                                                    disabled={page === 1}
                                                >
                                                    Previous
                                                </button>
                                                <span className="page-info">
                                                    Page {page} of {totalPages}
                                                </span>
                                                <button
                                                    className="page-btn"
                                                    onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                                                    disabled={page === totalPages}
                                                >
                                                    Next
                                                </button>
                                            </div>
                                        )}
                                    </>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
