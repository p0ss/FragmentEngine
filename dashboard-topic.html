<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Dashboard - Content Library</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            min-height: 100vh;
            color: #e7e9ea;
        }
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 260px;
            background: #16181c;
            border-right: 1px solid #2f3336;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo .material-icons { color: #f7b733; }
        .topic-selector {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #2f3336;
        }
        .topic-selector select {
            width: 100%;
            background: #1d1f23;
            border: 1px solid #2f3336;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e7e9ea;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-label {
            font-size: 0.75rem;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #e7e9ea;
            text-decoration: none;
            margin-bottom: 0.25rem;
            transition: background 0.2s;
        }
        .nav-item:hover { background: #1d1f23; }
        .nav-item.active { background: rgba(247,183,51,0.1); color: #f7b733; }
        .nav-item .material-icons { font-size: 1.25rem; opacity: 0.8; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .header {
            background: #16181c;
            border-bottom: 1px solid #2f3336;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header-subtitle { color: #71767b; font-size: 0.875rem; }
        .header-actions { display: flex; gap: 0.75rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: #f7b733; color: #000; }
        .btn-primary:hover { background: #e5a82e; }
        .btn-secondary { background: transparent; color: #e7e9ea; border: 1px solid #2f3336; }
        .btn-secondary:hover { background: #1d1f23; }
        .btn .material-icons { font-size: 1.125rem; }
        .content { flex: 1; padding: 2rem; overflow-y: auto; }
        .search-bar {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 2rem;
            padding: 0.875rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e7e9ea;
            font-size: 1rem;
            outline: none;
        }
        .search-bar input::placeholder { color: #71767b; }
        .ai-badge {
            background: linear-gradient(135deg, #f7b733, #fc4a1a);
            color: #fff;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 1rem;
            padding: 1.25rem;
        }
        .metric-label {
            font-size: 0.75rem;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
        }
        .metric-link {
            font-size: 0.75rem;
            color: #1d9bf0;
            text-decoration: none;
            margin-top: 0.25rem;
            display: inline-block;
        }
        .metric-link:hover { text-decoration: underline; }
        /* Real data = white, Not implemented = grey/disabled */
        .data-real { color: #fff !important; }
        .card-not-implemented {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(50%);
        }
        .card-not-implemented * {
            color: #71767b !important;
        }
        .card-not-implemented::before {
            content: 'Coming soon';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            color: #71767b;
            background: rgba(0,0,0,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            z-index: 10;
            font-weight: 500;
        }
        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card {
            position: relative;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 1rem;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #2f3336;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
        }
        .card-body { padding: 1.5rem; }
        .fragment-list { list-style: none; }
        .fragment-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #2f3336;
        }
        .fragment-item:last-child { border-bottom: none; }
        .fragment-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #2f3336;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .fragment-checkbox.checked {
            background: #f7b733;
            border-color: #f7b733;
        }
        .fragment-checkbox .material-icons { font-size: 1rem; color: #000; }
        .fragment-info { flex: 1; }
        .fragment-name { font-weight: 500; margin-bottom: 0.25rem; }
        .fragment-meta {
            font-size: 0.75rem;
            color: #71767b;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .fragment-status {
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
        }
        .fragment-status.current { background: rgba(0,186,124,0.15); color: #00ba7c; }
        .fragment-status.draft { background: rgba(255,217,61,0.15); color: #ffd93d; }
        .fragment-actions { display: flex; gap: 0.5rem; }
        .fragment-action {
            color: #1d9bf0;
            font-size: 0.75rem;
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }
        .fragment-action:hover { background: rgba(29,155,240,0.1); }
        .platform-using {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #2f3336;
        }
        .platform-using:last-child { border-bottom: none; }
        .platform-icon {
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            background: #1d1f23;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .platform-icon .material-icons { color: #71767b; font-size: 1rem; }
        .platform-name { flex: 1; font-size: 0.875rem; }
        .platform-status {
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            background: rgba(0,186,124,0.15);
            color: #00ba7c;
        }
        .subscriber-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }
        .subscriber-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fc4a1a, #f7b733);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }
        .subscriber-name { font-size: 0.875rem; }
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(244,33,46,0.1);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-item .material-icons { color: #f4212e; font-size: 1.25rem; }
        .alert-item.warning { background: rgba(255,217,61,0.1); }
        .alert-item.warning .material-icons { color: #ffd93d; }
        .alert-item.info { background: rgba(29,155,240,0.1); }
        .alert-item.info .material-icons { color: #1d9bf0; }
        .alert-text { font-size: 0.875rem; }
        .badge-count {
            background: #f4212e;
            color: #fff;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 0.75rem;
            margin-left: 0.5rem;
        }
        .view-all {
            display: block;
            text-align: center;
            color: #1d9bf0;
            font-size: 0.875rem;
            padding: 1rem;
            text-decoration: none;
            border-top: 1px solid #2f3336;
        }
        .view-all:hover { background: #1d1f23; }
        .contact-link {
            color: #1d9bf0;
            font-size: 0.75rem;
            text-decoration: none;
        }
        .contact-link:hover { text-decoration: underline; }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #71767b;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #2f3336;
            border-top-color: #f7b733;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 1rem;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #2f3336;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            color: #71767b;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            background: #1d1f23;
            border: 1px solid #2f3336;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: #e7e9ea;
            font-size: 0.875rem;
        }
        .form-input:focus { outline: none; border-color: #f7b733; }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        .form-help { font-size: 0.75rem; color: #71767b; margin-top: 0.25rem; }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #2f3336;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .similar-fragments {
            background: #1d1f23;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .similar-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }
        .similar-match { color: #f7b733; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const TYPESENSE_BASE = '/typesense';
        const TYPESENSE_KEY = 'your-secure-api-key-here';

        async function tsSearch(collection, params) {
            const query = new URLSearchParams(params).toString();
            const res = await fetch(`${TYPESENSE_BASE}/collections/${encodeURIComponent(collection)}/documents/search?${query}`, {
                method: 'GET',
                headers: { 'X-TYPESENSE-API-KEY': TYPESENSE_KEY }
            });
            if (!res.ok) throw new Error(`Typesense error: ${res.status}`);
            return res.json();
        }

        async function tsFacets(collection, facetBy, filterBy = '', maxFacets = 100) {
            const params = {
                q: '*',
                query_by: 'title',
                facet_by: facetBy,
                max_facet_values: maxFacets,
                per_page: 0
            };
            if (filterBy) params.filter_by = filterBy;
            return tsSearch(collection, params);
        }

        function App() {
            const [loading, setLoading] = useState(true);
            const [topics, setTopics] = useState([]);
            const [selectedTopic, setSelectedTopic] = useState('');
            const [hostFilter, setHostFilter] = useState('');
            const [fragments, setFragments] = useState([]);
            const [platforms, setPlatforms] = useState([]);
            const [metrics, setMetrics] = useState({
                platforms: 0,
                fragments: 0,
                seoAi: 0,
                subscribers: 0,
                readability: 8
            });
            const [alerts, setAlerts] = useState([]);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [newFragment, setNewFragment] = useState({ name: '', content: '' });
            const [similarFragments, setSimilarFragments] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');

            // Read URL params on mount
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const topicParam = params.get('topic');
                const hostParam = params.get('host');

                if (hostParam) {
                    setHostFilter(hostParam);
                }

                if (topicParam) {
                    // If topic provided via URL, set it directly
                    setSelectedTopic(topicParam);
                    setLoading(false);
                } else {
                    // Otherwise load topics normally
                    loadTopics();
                }
            }, []);

            useEffect(() => {
                if (selectedTopic) {
                    loadTopicData();
                }
            }, [selectedTopic]);

            async function loadTopics() {
                try {
                    // Load seed taxonomy for all possible life events
                    let seedTaxonomy = {};
                    try {
                        const resp = await fetch('/data/seed-taxonomies.json');
                        if (resp.ok) {
                            const data = await resp.json();
                            seedTaxonomy = data.lifeEvents || {};
                        }
                    } catch (e) {
                        console.warn('Could not load seed taxonomy:', e);
                    }

                    // Get discovered topics from Typesense
                    const lifeData = await tsFacets('content_pages', 'life_events', '', 100);
                    const lifeFacets = lifeData.facet_counts?.find(f => f.field_name === 'life_events')?.counts || [];

                    // Build count lookup from discovered topics
                    const countLookup = {};
                    lifeFacets.forEach(t => { countLookup[t.value] = t.count; });

                    // Merge: all taxonomy topics + any discovered topics not in taxonomy
                    const allTopics = new Set([
                        ...Object.keys(seedTaxonomy),
                        ...lifeFacets.map(t => t.value)
                    ]);

                    const topicList = Array.from(allTopics).map(topic => ({
                        value: topic,
                        label: topic,
                        count: countLookup[topic] || 0,
                        srrs: seedTaxonomy[topic]?.srrs || 0,
                        inTaxonomy: !!seedTaxonomy[topic],
                        hasContent: (countLookup[topic] || 0) > 0
                    }));

                    // Sort: topics with content first, then by SRRS score (higher stress = more important)
                    topicList.sort((a, b) => {
                        if (a.hasContent !== b.hasContent) return b.hasContent - a.hasContent;
                        return b.srrs - a.srrs;
                    });

                    setTopics(topicList);
                    if (topicList.length > 0) {
                        // Select first topic with content
                        const firstWithContent = topicList.find(t => t.hasContent);
                        setSelectedTopic(firstWithContent ? firstWithContent.value : topicList[0].value);
                    }
                    setLoading(false);
                } catch (err) {
                    console.error('Error loading topics:', err);
                    setLoading(false);
                }
            }

            async function loadTopicData() {
                setLoading(true);
                try {
                    // Step 1: Get pages that have this topic in their life_events
                    // Typesense requires backticks around filter values with spaces
                    let pageFilter = `life_events:=\`${selectedTopic}\``;
                    if (hostFilter) {
                        pageFilter += ` && host:=\`${hostFilter}\``;
                    }

                    const pagesData = await tsSearch('content_pages', {
                        q: '*',
                        query_by: 'title',
                        filter_by: pageFilter,
                        include_fields: 'url,title,host',
                        per_page: 50
                    });

                    const pageUrls = (pagesData.hits || []).map(hit => hit.document.url);

                    // Step 2: Get fragments for this topic
                    let fragmentList = [];
                    let totalFragments = 0;

                    // Helper to get URL path without query params or hash
                    function getUrlPath(url) {
                        try {
                            const u = new URL(url);
                            return u.origin + u.pathname;
                        } catch {
                            return url.split('?')[0].split('#')[0];
                        }
                    }

                    // Strategy 1: Search for the topic name directly in fragment content
                    console.log('Topic search:', { selectedTopic, hostFilter, pageUrlCount: pageUrls.length });

                    let fragData = await tsSearch('content_fragments', {
                        q: selectedTopic,
                        query_by: 'title,content_text',
                        include_fields: 'id,url,title,content_text,reading_level,component_type',
                        per_page: 100
                    });
                    console.log('Topic search results:', fragData.found, 'found,', fragData.hits?.length, 'returned');

                    fragmentList = (fragData.hits || [])
                        .filter(hit => {
                            const fragUrl = hit.document.url || '';
                            // If host filter is set, check URL contains host
                            if (hostFilter && !fragUrl.includes(hostFilter)) {
                                return false;
                            }
                            return true;
                        });
                    console.log('After host filter:', fragmentList.length, 'fragments');

                    // Strategy 2: If we have page URLs and few matches, also match by page URL
                    if (pageUrls.length > 0 && fragmentList.length < 10) {
                        const pageUrlPaths = pageUrls.map(u => getUrlPath(u));

                        // Fetch more fragments for URL matching
                        const moreFragData = await tsSearch('content_fragments', {
                            q: '*',
                            query_by: 'title,content_text',
                            include_fields: 'id,url,title,content_text,reading_level,component_type',
                            per_page: 500
                        });

                        const urlMatchedFragments = (moreFragData.hits || [])
                            .filter(hit => {
                                const fragUrl = hit.document.url || '';
                                if (hostFilter && !fragUrl.includes(hostFilter)) {
                                    return false;
                                }
                                const fragPath = getUrlPath(fragUrl);
                                return pageUrlPaths.some(pagePath =>
                                    fragPath === pagePath ||
                                    fragPath.startsWith(pagePath) ||
                                    pagePath.startsWith(fragPath)
                                );
                            });

                        // Combine results, removing duplicates
                        const existingIds = new Set(fragmentList.map(h => h.document?.id));
                        urlMatchedFragments.forEach(hit => {
                            if (!existingIds.has(hit.document?.id)) {
                                fragmentList.push(hit);
                            }
                        });
                    }

                    // Map to objects
                    fragmentList = fragmentList
                        .slice(0, 20)
                        .map((hit, i) => ({
                            id: hit.document.id || i,
                            name: hit.document.title || 'Untitled Fragment',
                            content_text: hit.document.content_text || '',
                            reading_level: hit.document.reading_level || 8,
                            component_type: hit.document.component_type || 'content',
                            url: hit.document.url,
                            page_url: (hit.document.url || '').split('#')[0],
                            expanded: false
                        }));

                    totalFragments = fragmentList.length;

                    setFragments(fragmentList);

                    // Get platforms (hosts) using this topic from content_pages
                    const platformData = await tsFacets('content_pages', 'host', `life_events:=\`${selectedTopic}\``, 20);
                    const platformFacets = platformData.facet_counts?.find(f => f.field_name === 'host')?.counts || [];

                    setPlatforms(platformFacets.slice(0, 6).map((p, i) => ({
                        id: i,
                        name: p.value,
                        count: p.count,
                        status: 'synced'
                    })));

                    // Calculate REAL metrics from fragment data
                    const readingLevels = fragmentList.map(f => f.reading_level).filter(r => r > 0);
                    const avgReadability = readingLevels.length > 0
                        ? Math.round(readingLevels.reduce((a, b) => a + b, 0) / readingLevels.length * 10) / 10
                        : 8;

                    // Count unique hosts across all fragments for "usedBy" calculation
                    const uniqueHosts = new Set(platformFacets.map(p => p.value));

                    setMetrics({
                        platforms: platformFacets.length,
                        fragments: fragmentList.length,
                        pages: pageUrls.length,
                        seoAi: Math.min(100, Math.round((12 - avgReadability) * 10)), // Lower reading level = better SEO
                        subscribers: platformFacets.length,
                        readability: avgReadability
                    });

                    // Generate alerts based on real data
                    const newAlerts = [];
                    if (avgReadability > 10) {
                        newAlerts.push({ type: 'warning', message: `High reading level (Grade ${avgReadability}) - consider simplifying content` });
                    }
                    if (platformFacets.length > 3) {
                        newAlerts.push({ type: 'info', message: `Topic used across ${platformFacets.length} platforms` });
                    }
                    if (fragmentList.length > 20) {
                        newAlerts.push({ type: 'info', message: `${fragmentList.length} fragments found - consider consolidation` });
                    }
                    setAlerts(newAlerts);

                } catch (err) {
                    console.error('Error loading topic data:', err);
                    alert('Error loading topic data: ' + err.message);
                }
                setLoading(false);
            }

            async function searchSimilarFragments(name) {
                if (!name || name.length < 3) {
                    setSimilarFragments([]);
                    return;
                }
                try {
                    const data = await tsSearch('content_fragments', {
                        q: name,
                        query_by: 'title,content_text',
                        per_page: 3
                    });
                    // Use Typesense text_match score to show relevance
                    const maxScore = data.hits?.[0]?.text_match || 1;
                    const similar = (data.hits || []).map(hit => ({
                        name: hit.document.title || 'Untitled',
                        match: Math.min(95, Math.round((hit.text_match / maxScore) * 90 + 5))
                    }));
                    setSimilarFragments(similar);
                } catch (err) {
                    console.error('Error searching similar:', err);
                }
            }

            function handleFragmentNameChange(e) {
                const name = e.target.value;
                setNewFragment({ ...newFragment, name });
                searchSimilarFragments(name);
            }

            async function handleSearch(e) {
                e.preventDefault();
                if (!searchQuery.trim()) return;
                window.location.href = `dashboard-unified.html?search=${encodeURIComponent(searchQuery)}`;
            }

            const subscribers = [
                { id: 1, name: 'Jane Wilson', initials: 'JW' },
                { id: 2, name: 'Mike Chen', initials: 'MC' },
                { id: 3, name: 'Sarah Lee', initials: 'SL' },
                { id: 4, name: 'Tom Brown', initials: 'TB' }
            ];

            return (
                <div className="app">
                    <aside className="sidebar">
                        <div className="logo">
                            <span className="material-icons">category</span>
                            Content Library
                        </div>
                        <div className="topic-selector">
                            <select value={selectedTopic} onChange={e => setSelectedTopic(e.target.value)}>
                                <optgroup label="Topics with Content">
                                    {topics.filter(t => t.hasContent).map(t => (
                                        <option key={t.value} value={t.value}>
                                            {t.label} ({t.count} pages){t.srrs > 0 ? ` • SRRS ${t.srrs}` : ''}
                                        </option>
                                    ))}
                                </optgroup>
                                <optgroup label="Coverage Gaps (No Content)">
                                    {topics.filter(t => !t.hasContent && t.inTaxonomy).map(t => (
                                        <option key={t.value} value={t.value} style={{color: '#c62828'}}>
                                            ⚠ {t.label} (0 pages){t.srrs > 0 ? ` • SRRS ${t.srrs}` : ''}
                                        </option>
                                    ))}
                                </optgroup>
                            </select>
                            <div style={{fontSize: '0.7rem', color: '#71767b', marginTop: '0.25rem', padding: '0 0.5rem'}}>
                                {topics.filter(t => t.hasContent).length} topics with content • {topics.filter(t => !t.hasContent && t.inTaxonomy).length} gaps
                            </div>
                        </div>

                        <nav className="nav-section">
                            <div className="nav-label">Views</div>
                            <a href="dashboard-portfolio.html" className="nav-item">
                                <span className="material-icons">account_balance</span>
                                Portfolio
                            </a>
                            <a href="dashboard-platform.html" className="nav-item">
                                <span className="material-icons">dns</span>
                                Platform
                            </a>
                            <a href="dashboard-topic.html" className="nav-item active">
                                <span className="material-icons">category</span>
                                Topics
                            </a>
                            <a href="dashboard-content.html" className="nav-item">
                                <span className="material-icons">article</span>
                                Content
                            </a>
                        </nav>

                        <nav className="nav-section">
                            <div className="nav-label">Tools</div>
                            <a href="dashboard-unified.html" className="nav-item">
                                <span className="material-icons">search</span>
                                Content Discovery
                            </a>
                            <a href="multimode-interface.html" className="nav-item">
                                <span className="material-icons">smart_toy</span>
                                AI Assistant
                            </a>
                            <a href="pages-analyse.html" className="nav-item">
                                <span className="material-icons">compare</span>
                                Similarity
                            </a>
                        </nav>
                    </aside>

                    <main className="main">
                        <header className="header">
                            <div className="header-left">
                                <div>
                                    <h1>Topic Dashboard</h1>
                                    <div className="header-subtitle">
                                        {hostFilter && (
                                            <span style={{marginRight: '0.5rem'}}>
                                                <a
                                                    href={`dashboard-platform.html?host=${encodeURIComponent(hostFilter)}`}
                                                    style={{color: '#1d9bf0', textDecoration: 'none'}}
                                                >{hostFilter}</a>
                                                <span style={{margin: '0 0.5rem', color: '#71767b'}}>/</span>
                                            </span>
                                        )}
                                        {selectedTopic}
                                    </div>
                                </div>
                            </div>
                            <div className="header-actions">
                                <button className="btn btn-secondary">
                                    <span className="material-icons">notifications</span>
                                    Alerts
                                    {alerts.length > 0 && <span className="badge-count">{alerts.length}</span>}
                                </button>
                                <button className="btn btn-secondary">
                                    <span className="material-icons">star_outline</span>
                                    Watchlist
                                </button>
                                <button className="btn btn-secondary">
                                    <span className="material-icons">compare_arrows</span>
                                    Compare
                                </button>
                                <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                                    <span className="material-icons">add</span>
                                    Add Fragment
                                </button>
                            </div>
                        </header>

                        <div className="content">
                            {loading ? (
                                <div className="loading">
                                    <div className="spinner"></div>
                                    Loading topic data...
                                </div>
                            ) : (
                                <>
                                    <form className="search-bar" onSubmit={handleSearch} style={{opacity: 0.7}}>
                                        <span className="material-icons" style={{color: '#71767b'}}>open_in_new</span>
                                        <input
                                            type="text"
                                            placeholder="Search opens AI chat interface..."
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                            style={{color: '#71767b'}}
                                        />
                                        <span className="ai-badge" style={{background: '#2f3336', color: '#71767b'}}>Opens Chat</span>
                                    </form>

                                    <div className="metrics-grid">
                                        <div className="metric-card">
                                            <div className="metric-label">Platforms</div>
                                            <div className="metric-value">{metrics.platforms}</div>
                                            <span style={{fontSize: '0.75rem', color: '#71767b'}}>using topic</span>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Fragments</div>
                                            <div className="metric-value">{metrics.fragments}</div>
                                            <span style={{fontSize: '0.75rem', color: '#71767b'}}>active</span>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">SEO/AI Status</div>
                                            <div className="metric-value">{metrics.seoAi}%</div>
                                            <span style={{fontSize: '0.75rem', color: '#71767b'}}>visible</span>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Subscribers</div>
                                            <div className="metric-value">{metrics.subscribers}</div>
                                            <a href="#" className="metric-link">View all</a>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Readability</div>
                                            <div className="metric-value" style={{color: metrics.readability <= 8 ? '#2e7d32' : metrics.readability <= 10 ? '#f57c00' : '#c62828'}}>
                                                Grade {metrics.readability}
                                            </div>
                                            <span style={{fontSize: '0.75rem', color: '#71767b'}}>
                                                {metrics.readability <= 6 ? 'Easy' : metrics.readability <= 8 ? 'Standard' : metrics.readability <= 10 ? 'Moderate' : 'Complex'}
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid-2col">
                                        <div className="card">
                                            <div className="card-header">
                                                <span className="card-title">
                                                    Fragments
                                                    <span style={{marginLeft: '0.5rem', fontSize: '0.75rem', color: '#71767b'}}>
                                                        ({metrics.fragments} from {metrics.pages || 0} pages)
                                                    </span>
                                                </span>
                                                <button className="btn btn-secondary" style={{padding: '0.375rem 0.75rem'}} onClick={() => setShowCreateModal(true)}>
                                                    <span className="material-icons" style={{fontSize: '1rem'}}>add</span>
                                                    Add new
                                                </button>
                                            </div>
                                            <div className="card-body">
                                                {fragments.length === 0 ? (
                                                    <div style={{textAlign: 'center', padding: '2rem', color: '#71767b'}}>
                                                        No content fragments found for this topic
                                                    </div>
                                                ) : (
                                                <ul className="fragment-list">
                                                    {fragments.map(fragment => (
                                                        <li key={fragment.id} className="fragment-item" style={{flexDirection: 'column', alignItems: 'stretch'}}>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                                                                <div className="fragment-checkbox">
                                                                    <span className="material-icons" style={{fontSize: '1rem', color: fragment.component_type === 'form' ? '#1976d2' : fragment.component_type === 'checklist' ? '#7b1fa2' : '#71767b'}}>
                                                                        {fragment.component_type === 'form' ? 'description' : fragment.component_type === 'checklist' ? 'checklist' : 'article'}
                                                                    </span>
                                                                </div>
                                                                <div
                                                                    className="fragment-info"
                                                                    style={{flex: 1, cursor: 'pointer'}}
                                                                    onClick={() => window.location.href = `dashboard-content.html?page_url=${encodeURIComponent(fragment.page_url)}`}
                                                                    title="View content page"
                                                                >
                                                                    <div className="fragment-name" style={{color: '#1d9bf0'}}>{fragment.name}</div>
                                                                    <div className="fragment-meta">
                                                                        <span
                                                                            className="readability-badge"
                                                                            style={{
                                                                                padding: '0.125rem 0.5rem',
                                                                                borderRadius: '0.75rem',
                                                                                fontSize: '0.7rem',
                                                                                fontWeight: 500,
                                                                                backgroundColor: fragment.reading_level <= 6 ? '#e8f5e9' : fragment.reading_level <= 8 ? '#fff3e0' : fragment.reading_level <= 10 ? '#fff8e1' : '#ffebee',
                                                                                color: fragment.reading_level <= 6 ? '#2e7d32' : fragment.reading_level <= 8 ? '#ef6c00' : fragment.reading_level <= 10 ? '#f57c00' : '#c62828'
                                                                            }}
                                                                        >
                                                                            Grade {fragment.reading_level}
                                                                        </span>
                                                                        <span style={{color: '#71767b', fontSize: '0.75rem'}}>{fragment.component_type}</span>
                                                                    </div>
                                                                </div>
                                                                <div className="fragment-actions" style={{display: 'flex', gap: '0.5rem'}}>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); setFragments(fragments.map(f => f.id === fragment.id ? {...f, expanded: !f.expanded} : f)); }}
                                                                        style={{background: 'none', border: 'none', cursor: 'pointer', padding: '0.25rem'}}
                                                                        title={fragment.expanded ? 'Collapse' : 'Expand content'}
                                                                    >
                                                                        <span className="material-icons" style={{fontSize: '1.25rem', color: '#536471'}}>
                                                                            {fragment.expanded ? 'expand_less' : 'expand_more'}
                                                                        </span>
                                                                    </button>
                                                                    <a href={fragment.url} target="_blank" className="fragment-action" style={{fontSize: '0.75rem'}} onClick={e => e.stopPropagation()}>View</a>
                                                                </div>
                                                            </div>
                                                            {fragment.expanded && fragment.content_text && (
                                                                <div style={{
                                                                    marginTop: '0.75rem',
                                                                    padding: '0.75rem',
                                                                    backgroundColor: '#f8f9fa',
                                                                    borderRadius: '0.5rem',
                                                                    fontSize: '0.8rem',
                                                                    lineHeight: 1.5,
                                                                    color: '#333',
                                                                    maxHeight: '200px',
                                                                    overflow: 'auto'
                                                                }}>
                                                                    {fragment.content_text.length > 500
                                                                        ? fragment.content_text.substring(0, 500) + '...'
                                                                        : fragment.content_text}
                                                                </div>
                                                            )}
                                                        </li>
                                                    ))}
                                                </ul>
                                                )}
                                            </div>
                                            <a
                                                href={`dashboard-unified.html?topic=${encodeURIComponent(selectedTopic)}${hostFilter ? '&platform=' + encodeURIComponent(hostFilter) : ''}`}
                                                className="view-all"
                                            >
                                                View all in search
                                            </a>
                                        </div>

                                        <div>
                                            <div className="card" style={{marginBottom: '1.5rem'}}>
                                                <div className="card-header">
                                                    <span className="card-title">Platforms Using Topic</span>
                                                </div>
                                                <div className="card-body">
                                                    {platforms.map(platform => (
                                                        <div
                                                            key={platform.id}
                                                            className="platform-using"
                                                            style={{cursor: 'pointer'}}
                                                            onClick={() => window.location.href = `dashboard-platform.html?host=${encodeURIComponent(platform.name)}`}
                                                            title={`View ${platform.name} platform`}
                                                        >
                                                            <div className="platform-icon">
                                                                <span className="material-icons">language</span>
                                                            </div>
                                                            <span className="platform-name" style={{color: '#1d9bf0'}}>{platform.name}</span>
                                                            <span className="platform-status">{platform.count} pages</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="card card-not-implemented">
                                                <div className="card-header">
                                                    <span className="card-title">Subscribers</span>
                                                    <a href="#" className="contact-link">View all ({metrics.subscribers})</a>
                                                </div>
                                                <div className="card-body">
                                                    {subscribers.map(sub => (
                                                        <div key={sub.id} className="subscriber-item">
                                                            <div className="subscriber-avatar">{sub.initials}</div>
                                                            <span className="subscriber-name">{sub.name}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="card">
                                        <div className="card-header">
                                            <span className="card-title">Alerts</span>
                                            {alerts.length > 0 && <span className="badge-count">{alerts.length}</span>}
                                        </div>
                                        <div className="card-body">
                                            {alerts.length === 0 ? (
                                                <p style={{color: '#71767b', textAlign: 'center', padding: '1rem'}}>
                                                    No alerts at this time
                                                </p>
                                            ) : (
                                                alerts.map((alert, i) => (
                                                    <div key={i} className={`alert-item ${alert.type}`}>
                                                        <span className="material-icons">
                                                            {alert.type === 'error' ? 'error' : alert.type === 'warning' ? 'warning' : 'info'}
                                                        </span>
                                                        <span className="alert-text">{alert.message}</span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </main>

                    {showCreateModal && (
                        <div className="modal-overlay" onClick={() => setShowCreateModal(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <span className="modal-title">Create New Fragment</span>
                                    <button className="modal-close" onClick={() => setShowCreateModal(false)}>
                                        <span className="material-icons">close</span>
                                    </button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-group">
                                        <label className="form-label">Fragment Name</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="e.g., Carer Payment eligibility"
                                            value={newFragment.name}
                                            onChange={handleFragmentNameChange}
                                        />
                                        {similarFragments.length > 0 && (
                                            <div className="similar-fragments">
                                                <div style={{fontSize: '0.75rem', color: '#71767b', marginBottom: '0.5rem'}}>
                                                    Similar fragments found:
                                                </div>
                                                {similarFragments.map((sf, i) => (
                                                    <div key={i} className="similar-item">
                                                        <span>{sf.name}</span>
                                                        <span className="similar-match">{sf.match}% match</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Content</label>
                                        <textarea
                                            className="form-input form-textarea"
                                            placeholder="Enter the fragment content..."
                                            value={newFragment.content}
                                            onChange={e => setNewFragment({...newFragment, content: e.target.value})}
                                        ></textarea>
                                        <div className="form-help">Use plain language. Aim for Grade 8 reading level.</div>
                                    </div>
                                    <div className="form-group">
                                        <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                                            <input type="checkbox" defaultChecked />
                                            <span style={{fontSize: '0.875rem'}}>Notify subscribers when updated</span>
                                        </label>
                                    </div>
                                    <div className="form-group">
                                        <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                                            <input type="checkbox" />
                                            <span style={{fontSize: '0.875rem'}}>Require approval before sites can modify</span>
                                        </label>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setShowCreateModal(false)}>Cancel</button>
                                    <button className="btn btn-primary">Create Fragment</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
