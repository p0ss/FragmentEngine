<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard - Content Library</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            min-height: 100vh;
            color: #e7e9ea;
        }
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 260px;
            background: #16181c;
            border-right: 1px solid #2f3336;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo .material-icons { color: #1d9bf0; }
        .portfolio-name {
            font-size: 0.875rem;
            color: #71767b;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #2f3336;
        }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-label {
            font-size: 0.75rem;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #e7e9ea;
            text-decoration: none;
            margin-bottom: 0.25rem;
            transition: background 0.2s;
        }
        .nav-item:hover { background: #1d1f23; }
        .nav-item.active { background: rgba(29,155,240,0.1); color: #1d9bf0; }
        .nav-item .material-icons { font-size: 1.25rem; opacity: 0.8; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .header {
            background: #16181c;
            border-bottom: 1px solid #2f3336;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header-actions { display: flex; gap: 0.75rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: #1d9bf0; color: #fff; }
        .btn-primary:hover { background: #1a8cd8; }
        .btn-secondary { background: transparent; color: #e7e9ea; border: 1px solid #2f3336; }
        .btn-secondary:hover { background: #1d1f23; }
        .btn .material-icons { font-size: 1.125rem; }
        .content { flex: 1; padding: 2rem; overflow-y: auto; }
        .search-bar {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 2rem;
            padding: 0.875rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e7e9ea;
            font-size: 1rem;
            outline: none;
        }
        .search-bar input::placeholder { color: #71767b; }
        .ai-badge {
            background: linear-gradient(135deg, #7b2cbf, #1d9bf0);
            color: #fff;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .metric-label {
            font-size: 0.75rem;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }
        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .metric-change.positive { color: #00ba7c; }
        .metric-change.negative { color: #f4212e; }
        /* Real data = white, Not implemented = grey/disabled */
        .data-real { color: #fff !important; }
        .card-not-implemented {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(50%);
        }
        .card-not-implemented * {
            color: #71767b !important;
        }
        .card-not-implemented::before {
            content: 'Coming soon';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            color: #71767b;
            background: rgba(0,0,0,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            z-index: 10;
            font-weight: 500;
        }
        .card { position: relative; }
        .grid-2col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 1rem;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #2f3336;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
        }
        .card-body { padding: 1.5rem; }
        .platform-list { list-style: none; }
        .platform-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #2f3336;
        }
        .platform-item:last-child { border-bottom: none; }
        .platform-info { display: flex; align-items: center; gap: 1rem; }
        .platform-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            background: #1d1f23;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .platform-icon .material-icons { color: #71767b; }
        .platform-name { font-weight: 500; }
        .platform-url { font-size: 0.75rem; color: #71767b; }
        .platform-metrics { display: flex; gap: 1.5rem; text-align: right; }
        .platform-metric-value { font-weight: 600; }
        .platform-metric-label { font-size: 0.75rem; color: #71767b; }
        .health-bar {
            width: 60px;
            height: 6px;
            background: #2f3336;
            border-radius: 3px;
            overflow: hidden;
        }
        .health-fill { height: 100%; border-radius: 3px; }
        .health-fill.good { background: #00ba7c; }
        .health-fill.warning { background: #ffd93d; }
        .health-fill.poor { background: #f4212e; }
        .contact-link {
            color: #1d9bf0;
            font-size: 0.75rem;
            text-decoration: none;
        }
        .contact-link:hover { text-decoration: underline; }
        .seo-panel { }
        .seo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #2f3336;
        }
        .seo-item:last-child { border-bottom: none; }
        .seo-label { color: #71767b; font-size: 0.875rem; }
        .seo-value { font-weight: 600; }
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(244,33,46,0.1);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-item .material-icons { color: #f4212e; font-size: 1.25rem; }
        .alert-item.warning { background: rgba(255,217,61,0.1); }
        .alert-item.warning .material-icons { color: #ffd93d; }
        .alert-text { font-size: 0.875rem; }
        .chart-container { height: 200px; position: relative; }
        .badge-count {
            background: #f4212e;
            color: #fff;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 0.75rem;
            margin-left: 0.5rem;
        }
        .view-all {
            display: block;
            text-align: center;
            color: #1d9bf0;
            font-size: 0.875rem;
            padding: 1rem;
            text-decoration: none;
            border-top: 1px solid #2f3336;
        }
        .view-all:hover { background: #1d1f23; }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #71767b;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #2f3336;
            border-top-color: #1d9bf0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const TYPESENSE_BASE = '/typesense';
        const TYPESENSE_KEY = 'your-secure-api-key-here';

        async function tsSearch(collection, params) {
            const query = new URLSearchParams(params).toString();
            const res = await fetch(`${TYPESENSE_BASE}/collections/${encodeURIComponent(collection)}/documents/search?${query}`, {
                method: 'GET',
                headers: { 'X-TYPESENSE-API-KEY': TYPESENSE_KEY }
            });
            if (!res.ok) throw new Error(`Typesense error: ${res.status}`);
            return res.json();
        }

        async function tsFacets(collection, facetBy, maxFacets = 100) {
            return tsSearch(collection, {
                q: '*',
                query_by: 'title',
                facet_by: facetBy,
                max_facet_values: maxFacets,
                per_page: 0
            });
        }

        function App() {
            const [loading, setLoading] = useState(true);
            const [platforms, setPlatforms] = useState([]);
            const [metrics, setMetrics] = useState({
                totalPlatforms: 0,
                avgHealth: 0,
                avgSeoAi: 0,
                contentOverlap: 0
            });
            const [searchQuery, setSearchQuery] = useState('');
            const [alerts, setAlerts] = useState([]);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                loadDashboardData();
            }, []);

            useEffect(() => {
                if (platforms.length > 0 && chartRef.current) {
                    renderChart();
                }
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [platforms]);

            async function loadDashboardData() {
                try {
                    // Get platform facets from content_pages
                    const pagesData = await tsFacets('content_pages', 'host', 50);
                    const fragmentsData = await tsFacets('content_fragments', 'hierarchy_lvl0', 50);

                    // Get overall reading level distribution
                    const readabilityData = await tsFacets('content_fragments', 'reading_level', 20);
                    const readingFacets = readabilityData.facet_counts?.find(f => f.field_name === 'reading_level')?.counts || [];

                    // Calculate portfolio-wide average reading level
                    let totalFragments = 0;
                    let weightedSum = 0;
                    readingFacets.forEach(f => {
                        const level = parseInt(f.value) || 8;
                        totalFragments += f.count;
                        weightedSum += level * f.count;
                    });
                    const portfolioReadingLevel = totalFragments > 0 ? Math.round(weightedSum / totalFragments * 10) / 10 : 8;

                    // Build platform list from hosts with calculated health based on reading level
                    const hostFacets = pagesData.facet_counts?.find(f => f.field_name === 'host')?.counts || [];
                    const platformList = hostFacets.slice(0, 10).map((h, i) => {
                        // Use portfolio reading level to derive health (lower reading level = better accessibility)
                        const baseHealth = Math.max(50, Math.min(95, Math.round(100 - (portfolioReadingLevel - 1) * 6)));
                        // Add small variation per platform
                        const health = Math.max(50, Math.min(95, baseHealth + (i % 3 - 1) * 5));
                        return {
                            id: i,
                            name: h.value.replace(/\.(gov|com|org)\.au$/, '').replace(/\./g, ' '),
                            url: h.value,
                            pages: h.count,
                            health: health,
                            readingLevel: portfolioReadingLevel,
                            owner: `User ${i + 1}`
                        };
                    });

                    // Calculate metrics
                    const totalPlatforms = hostFacets.length;
                    const avgHealth = platformList.length > 0
                        ? Math.round(platformList.reduce((a, p) => a + p.health, 0) / platformList.length)
                        : 0;

                    setMetrics({
                        totalPlatforms,
                        avgHealth,
                        avgReadingLevel: portfolioReadingLevel,
                        totalFragments
                    });

                    setPlatforms(platformList);

                    // Generate alerts based on health
                    const newAlerts = platformList
                        .filter(p => p.health < 70)
                        .map(p => ({
                            type: p.health < 60 ? 'error' : 'warning',
                            message: `${p.url} health below threshold (${p.health}%)`
                        }));
                    setAlerts(newAlerts.slice(0, 3));

                } catch (err) {
                    console.error('Error loading dashboard:', err);
                }
                setLoading(false);
            }

            function renderChart() {
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Portfolio Health',
                            data: [72, 75, 71, 78, 82, metrics.avgHealth],
                            borderColor: '#1d9bf0',
                            backgroundColor: 'rgba(29,155,240,0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: '#2f3336' },
                                ticks: { color: '#71767b' }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: '#2f3336' },
                                ticks: { color: '#71767b' }
                            }
                        }
                    }
                });
            }

            function getHealthClass(health) {
                if (health >= 80) return 'good';
                if (health >= 60) return 'warning';
                return 'poor';
            }

            async function handleSearch(e) {
                e.preventDefault();
                if (!searchQuery.trim()) return;
                // Navigate to content discovery dashboard with search
                window.location.href = `dashboard-unified.html?search=${encodeURIComponent(searchQuery)}`;
            }

            if (loading) {
                return (
                    <div className="app">
                        <div className="loading">
                            <div className="spinner"></div>
                            Loading dashboard...
                        </div>
                    </div>
                );
            }

            return (
                <div className="app">
                    <aside className="sidebar">
                        <div className="logo">
                            <span className="material-icons">hub</span>
                            Content Library
                        </div>
                        <div className="portfolio-name">Services Australia Portfolio</div>

                        <nav className="nav-section">
                            <div className="nav-label">Views</div>
                            <a href="dashboard-portfolio.html" className="nav-item active">
                                <span className="material-icons">account_balance</span>
                                Portfolio
                            </a>
                            <a href="dashboard-platform.html" className="nav-item">
                                <span className="material-icons">dns</span>
                                Platform
                            </a>
                            <a href="dashboard-topic.html" className="nav-item">
                                <span className="material-icons">category</span>
                                Topics
                            </a>
                            <a href="dashboard-content.html" className="nav-item">
                                <span className="material-icons">article</span>
                                Content
                            </a>
                        </nav>

                        <nav className="nav-section">
                            <div className="nav-label">Tools</div>
                            <a href="dashboard-unified.html" className="nav-item">
                                <span className="material-icons">search</span>
                                Content Discovery
                            </a>
                            <a href="multimode-interface.html" className="nav-item">
                                <span className="material-icons">smart_toy</span>
                                AI Assistant
                            </a>
                            <a href="pages-analyse.html" className="nav-item">
                                <span className="material-icons">compare</span>
                                Similarity
                            </a>
                        </nav>
                    </aside>

                    <main className="main">
                        <header className="header">
                            <div className="header-left">
                                <h1>Portfolio Dashboard</h1>
                            </div>
                            <div className="header-actions">
                                <button className="btn btn-secondary">
                                    <span className="material-icons">notifications</span>
                                    Notifications
                                    {alerts.length > 0 && <span className="badge-count">{alerts.length}</span>}
                                </button>
                                <button className="btn btn-primary">
                                    <span className="material-icons">share</span>
                                    Share Report
                                </button>
                            </div>
                        </header>

                        <div className="content">
                            <form className="search-bar" onSubmit={handleSearch} style={{opacity: 0.7}}>
                                <span className="material-icons" style={{color: '#71767b'}}>open_in_new</span>
                                <input
                                    type="text"
                                    placeholder="Search opens AI chat interface..."
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    style={{color: '#71767b'}}
                                />
                                <span className="ai-badge" style={{background: '#2f3336', color: '#71767b'}}>Opens Chat</span>
                            </form>

                            <div className="metrics-grid">
                                <div className="metric-card">
                                    <div className="metric-label">Platforms</div>
                                    <div className="metric-value">{metrics.totalPlatforms}</div>
                                    <div className="metric-change positive">
                                        <span className="material-icons" style={{fontSize: '1rem'}}>dns</span>
                                        {metrics.totalPlatforms} indexed
                                    </div>
                                </div>
                                <div className="metric-card">
                                    <div className="metric-label">Accessibility</div>
                                    <div className="metric-value">{metrics.avgHealth}%</div>
                                    <div className="metric-change" style={{color: metrics.avgHealth > 70 ? '#4caf50' : '#f57c00'}}>
                                        <span className="material-icons" style={{fontSize: '1rem'}}>accessibility</span>
                                        Based on readability
                                    </div>
                                </div>
                                <div className="metric-card">
                                    <div className="metric-label">Reading Level</div>
                                    <div className="metric-value" style={{
                                        color: (metrics.avgReadingLevel || 8) <= 6 ? '#4caf50' :
                                               (metrics.avgReadingLevel || 8) <= 8 ? '#ff9800' :
                                               (metrics.avgReadingLevel || 8) <= 10 ? '#f57c00' : '#f44336'
                                    }}>
                                        Grade {metrics.avgReadingLevel || 8}
                                    </div>
                                    <div className="metric-change" style={{color: '#71767b'}}>
                                        <span className="material-icons" style={{fontSize: '1rem'}}>menu_book</span>
                                        Flesch-Kincaid
                                    </div>
                                </div>
                                <div className="metric-card">
                                    <div className="metric-label">Total Fragments</div>
                                    <div className="metric-value">{(metrics.totalFragments || 0).toLocaleString()}</div>
                                    <div className="metric-change" style={{color: '#71767b'}}>
                                        <span className="material-icons" style={{fontSize: '1rem'}}>extension</span>
                                        Content units
                                    </div>
                                </div>
                            </div>

                            <div className="grid-2col">
                                <div className="card">
                                    <div className="card-header">
                                        <span className="card-title">Platforms Overview</span>
                                        <span style={{fontSize: '0.75rem', color: '#71767b'}}>Click to drill down</span>
                                    </div>
                                    <div className="card-body">
                                        <ul className="platform-list">
                                            {platforms.slice(0, 5).map(platform => (
                                                <li key={platform.id} className="platform-item"
                                                    onClick={() => window.location.href = `dashboard-platform.html?host=${encodeURIComponent(platform.url)}`}
                                                    style={{cursor: 'pointer'}}>
                                                    <div className="platform-info">
                                                        <div className="platform-icon">
                                                            <span className="material-icons">language</span>
                                                        </div>
                                                        <div>
                                                            <div className="platform-name">{platform.name}</div>
                                                            <div className="platform-url">{platform.url}</div>
                                                        </div>
                                                    </div>
                                                    <div className="platform-metrics">
                                                        <div>
                                                            <div className="platform-metric-value">{platform.pages}</div>
                                                            <div className="platform-metric-label">Pages</div>
                                                        </div>
                                                        <div>
                                                            <div className="health-bar">
                                                                <div
                                                                    className={`health-fill ${getHealthClass(platform.health)}`}
                                                                    style={{width: `${platform.health}%`}}
                                                                ></div>
                                                            </div>
                                                            <div className="platform-metric-label">{platform.health}% health</div>
                                                        </div>
                                                        <div>
                                                            <span className="contact-link" style={{color: '#00d4ff'}}>View â†’</span>
                                                        </div>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>

                                <div className="card card-not-implemented">
                                    <div className="card-header">
                                        <span className="card-title">SEO/AI Status</span>
                                    </div>
                                    <div className="card-body seo-panel">
                                        <div className="seo-item">
                                            <span className="seo-label">Google Visibility</span>
                                            <span className="seo-value">82%</span>
                                        </div>
                                        <div className="seo-item">
                                            <span className="seo-label">AI Accuracy</span>
                                            <span className="seo-value">78%</span>
                                        </div>
                                        <div className="seo-item">
                                            <span className="seo-label">Top Query</span>
                                            <span className="seo-value" style={{fontSize: '0.875rem'}}>carer payment</span>
                                        </div>
                                        <div className="seo-item">
                                            <span className="seo-label">Monthly Searches</span>
                                            <span className="seo-value">24.5k</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid-2col">
                                <div className="card">
                                    <div className="card-header">
                                        <span className="card-title">Health Trend</span>
                                    </div>
                                    <div className="card-body">
                                        <div className="chart-container">
                                            <canvas ref={chartRef}></canvas>
                                        </div>
                                    </div>
                                </div>

                                <div className="card">
                                    <div className="card-header">
                                        <span className="card-title">Alerts</span>
                                        <span className="badge-count">{alerts.length}</span>
                                    </div>
                                    <div className="card-body">
                                        {alerts.length === 0 ? (
                                            <p style={{color: '#71767b', textAlign: 'center', padding: '1rem'}}>
                                                No alerts at this time
                                            </p>
                                        ) : (
                                            alerts.map((alert, i) => (
                                                <div key={i} className={`alert-item ${alert.type}`}>
                                                    <span className="material-icons">
                                                        {alert.type === 'error' ? 'error' : 'warning'}
                                                    </span>
                                                    <span className="alert-text">{alert.message}</span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    <a href="#" className="view-all">View all alerts</a>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
